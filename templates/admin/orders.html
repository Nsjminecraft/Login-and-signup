{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">Orders Management</h1>
        <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>
    
    <!-- Orders Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card border-0 bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase text-white-50 small mb-1">Total Orders</h6>
                            <h3 class="mb-0">{{ order_count }}</h3>
                        </div>
                        <i class="bi bi-cart-check fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase text-white-50 small mb-1">Total Revenue</h6>
                            <h3 class="mb-0">{{ "%.2f"|format(total_order_value) }}</h3>
                        </div>
                        <i class="bi bi-currency-dollar fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-uppercase text-white-50 small mb-1">Avg. Order Value</h6>
                            <h3 class="mb-0">{{ "%.2f"|format(total_order_value / order_count if order_count > 0 else 0) }}</h3>
                        </div>
                        <i class="bi bi-graph-up fs-1 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-box-seam me-2"></i>All Orders</h5>
                <span class="badge bg-primary rounded-pill">{{ orders|length }} order{% if orders|length != 1 %}s{% endif %}</span>
            </div>
        </div>
        
        <div class="card-body p-0">
            {% if orders %}
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-3">Order ID</th>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Shipping</th>
                                <th class="text-center">Items</th>
                                <th class="text-end">Total</th>
                                <th class="text-center">Status</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in orders %}
                            <tr class="align-middle clickable-row" data-href="{{ url_for('order.order_detail', order_id=order._id) }}">
                                <td class="ps-3"><code class="small">#{{ order._id|truncate(8, True, '') }}</code></td>
                                <td>
                                    {% if order.created_at and order.created_at is not string %}
                                        {{ order.created_at.strftime('%b %d, %Y') }}
                                    {% else %}
                                        {{ order.created_at|default('N/A') }}
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="me-2">
                                            <i class="bi bi-person-circle fs-5"></i>
                                        </div>
                                        <div>
                                            {% set display_name = order.user_name if order.user_name and order.user_name != 'Guest' else 'Guest Checkout' %}
                                            {% set is_guest = not order.user_name or order.user_name == 'Guest' %}
                                            
                                            <div class="fw-medium {% if is_guest %}text-muted{% endif %}" 
                                                 title="{% if not is_guest %}User ID: {{ order.user_id }}{% else %}Guest Checkout{% endif %}">
                                                {{ display_name }}
                                            </div>
                                            
                                            <div class="text-muted small">
                                                <i class="bi bi-envelope me-1"></i>
                                                {% set order_email = order.checkout_email or order.email or order.user_email %}
                                                {% set shipping_email = order.shipping_info.email if order.shipping_info and order.shipping_info.email else '' %}
                                                {% set display_email = order_email if order_email and order_email != 'No email' else shipping_email %}
                                                
                                                {% if display_email %}
                                                    <a href="mailto:{{ display_email }}" class="text-muted text-decoration-none" 
                                                       title="{% if order_email and shipping_email and order_email != shipping_email %}
                                                           Original: {{ order_email }}
                                                       {% endif %}">
                                                        {{ display_email }}
                                                        {% if is_guest %}
                                                            <span class="badge bg-secondary ms-1" style="font-size: 0.6rem;">Guest</span>
                                                        {% endif %}
                                                    </a>
                                                {% else %}
                                                    <span class="text-muted">No email provided</span>
                                                {% endif %}
                                                
                                                {% if order.stripe_customer_id %}
                                                    <div class="mt-1">
                                                        <small class="text-muted">
                                                            <i class="bi bi-credit-card"></i> 
                                                            <span class="font-monospace small">{{ order.stripe_customer_id|truncate(8, True, '') }}</span>
                                                        </small>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if order.shipping_address %}
                                        <div class="small">
                                            <div>{{ order.shipping_address.get('name', '') }}</div>
                                            <div class="text-muted">
                                                {{ order.shipping_address.get('address', {}).get('city', '') }}, 
                                                {{ order.shipping_address.get('address', {}).get('country', '')|upper }}
                                            </div>
                                            {% if order.shipping_address.get('phone') %}
                                                <div class="text-muted">{{ order.shipping_address.phone }}</div>
                                            {% endif %}
                                        </div>
                                    {% else %}
                                        <span class="text-muted small">No shipping info</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">{{ order.order_items|length }}</td>
                                <td class="text-end fw-bold">
                                    {% set total = order.display_total or order.total_amount %}
                                    {% if total is defined and total is not none %}
                                        {% if total is string %}
                                            {{ total }}
                                        {% else %}
                                            â‚¹{{ "%.2f"|format(total) }}
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <form method="POST" action="{{ url_for('order.update_order_status') }}">
                                        <input type="hidden" name="order_id" value="{{ order._id }}">
                                        <div class="input-group input-group-sm" style="width: auto;">
                                            <select name="status" class="form-select status-select" data-status="{{ order.status }}">
                                                {% for value, label in status_choices %}
                                                    <option value="{{ value }}" {% if order.status == value %}selected{% endif %}>{{ label }}</option>
                                                {% endfor %}
                                            </select>
                                            <button type="submit" class="btn btn-primary btn-sm">
                                                <i class="bi bi-arrow-repeat"></i> Update
                                            </button>
                                        </div>
                                    </form>
                                </td>
                                <td class="text-center">
                                    <div class="btn-group">
                                        <a href="{{ url_for('order.order_detail', order_id=order._id) }}"
                                           class="btn btn-sm btn-outline-dark"
                                           title="View Order">
                                            <i class="bi bi-eye me-1"></i> View
                                        </a>
                                        <form method="POST" action="{{ url_for('order.cancel_order', order_id=order._id) }}" onsubmit="return confirm('Are you sure you want to cancel this order?')">
                                            <button type="submit" class="btn btn-sm btn-outline-danger ms-1" title="Cancel Order">
                                                <i class="bi bi-x-circle me-1"></i> Cancel
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center p-5">
                    <i class="bi bi-info-circle fs-1 text-muted"></i>
                    <p class="mt-3">No orders found.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>


{% endblock %}

{% block styles %}
<style>
    .status-select {
        color: white;
        border: none;
        font-weight: 500;
        padding: 0.25rem 0.5rem;
        transition: background-color 0.3s ease;
    }
    .status-select option {
        color: #000;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Status colors mapping
    const statusColors = {
        'Delivered': '#198754',
        'Canceled': '#dc3545',
        'Failed Delivery': '#dc3545',
        'Shipment Failed': '#dc3545',
        'Shipped': '#0dcaf0',
        'Processing': '#0d6efd',
        'Order Processing': '#0d6efd',
        'Order Placed': '#6c757d',
        'Order Confirmed': '#0dcaf0'
    };

    // Apply initial background colors to status selects
    function updateSelectColor(select) {
        const status = select.value;
        const bgColor = statusColors[status] || '#6c757d';
        select.style.backgroundColor = bgColor;
        select.style.color = '#fff';
        select.style.border = 'none';
        select.style.borderRadius = '0.25rem';
        select.style.padding = '0.25rem 0.5rem';
        select.style.fontWeight = '500';
        select.style.minWidth = '150px';
        return bgColor;
    }
    
    // Initialize all select elements with their proper colors
    document.querySelectorAll('.status-select').forEach(select => {
        // Set initial color based on data-status attribute
        const status = select.getAttribute('data-status');
        if (status) {
            select.value = status;
        }
        updateSelectColor(select);
        
        // Update color when selection changes
        select.addEventListener('change', function() {
            updateSelectColor(this);
        });
    });
    
    // Make table rows clickable, but exclude form elements and buttons
    const rows = document.querySelectorAll('.clickable-row');
    rows.forEach(row => {
        row.addEventListener('click', (event) => {
            // Prevent navigation if the click is on a button, link, or form element
            if (event.target.closest('a, button, .btn-group, select, .form-select, .btn, form, input')) {
                return;
            }
            const href = row.dataset.href;
            if (href) {
                window.location.href = href;
            }
        });
    });
    
    // Show flash messages if they exist
    const flashMessages = [];
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                flashMessages.push({category: '{{ category }}', message: '{{ message }}'});
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    // Function to show alert messages
    function showAlert(type, message) {
        // Remove any existing alerts
        document.querySelectorAll('.global-alert').forEach(alert => alert.remove());
        
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3 global-alert`;
        alert.style.zIndex = '1100';
        alert.style.maxWidth = '350px';
        alert.innerHTML = `
            <i class="bi ${type === 'success' ? 'bi-check-circle' : 'bi-exclamation-triangle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.body.appendChild(alert);
        
        // Remove alert after 5 seconds
        setTimeout(() => {
            alert.classList.remove('show');
            setTimeout(() => alert.remove(), 150);
        }, 5000);
    }
    
    // Display any flash messages
    flashMessages.forEach(msg => {
        showAlert(msg.category, msg.message);
    });
});
</script>
{% endblock %}
